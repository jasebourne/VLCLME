<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Name & Number Exporter - Multiple Images</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI Multi-Image Exporter</h1>
            <p class="text-gray-600 mt-2">Upload multiple images, extract data with Google AI, and export to a single CSV.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Left Column: Image and Controls -->
            <div class="flex flex-col items-center">
                <div id="previews-container" class="w-full min-h-[200px] bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center flex justify-center items-center">
                    <p id="previews-placeholder" class="text-gray-500">Image previews will appear here.</p>
                    <div id="image-previews" class="flex flex-wrap justify-center gap-4"></div>
                </div>
                <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
                <button id="upload-button" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Upload Image(s)
                </button>
                <button id="process-button" class="mt-2 w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-600 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500" disabled>
                    Process Images with AI
                </button>
                <div id="status" class="mt-4 text-center text-gray-600 h-12 flex items-center justify-center">
                    <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 hidden"></div>
                    <p id="status-text"></p>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="bg-gray-50 rounded-lg p-4 md:p-6 shadow-inner">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Combined Results</h2>
                    <button id="export-button" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 hidden">
                        Export to CSV
                    </button>
                </div>
                <div id="result-container" class="overflow-auto" style="max-height: 400px;">
                    <table class="w-full min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="2" class="px-6 py-10 text-center text-gray-500">Process image(s) to see results.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const uploadButton = document.getElementById('upload-button');
        const imagePreviews = document.getElementById('image-previews');
        const previewsPlaceholder = document.getElementById('previews-placeholder');
        const processButton = document.getElementById('process-button');
        const exportButton = document.getElementById('export-button');
        const resultsBody = document.getElementById('results-body');
        const statusText = document.getElementById('status-text');
        const loader = document.getElementById('loader');
        
        let extractedData = [];
        let filesToProcess = []; // Added to store the actual file objects

        uploadButton.addEventListener('click', () => imageUpload.click());

        imageUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            filesToProcess = Array.from(files); // Store the files array
            imagePreviews.innerHTML = '';
            previewsPlaceholder.classList.add('hidden');
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = "w-24 h-24 object-cover rounded-md shadow-md";
                    imagePreviews.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
            
            processButton.disabled = false;
            resultsBody.innerHTML = `<tr><td colspan="2" class="px-6 py-10 text-center text-gray-500">${files.length} image(s) loaded. Ready to process.</td></tr>`;
            exportButton.classList.add('hidden');
        });
        
        processButton.addEventListener('click', async () => {
            const previewImages = imagePreviews.querySelectorAll('img');
            if (previewImages.length === 0 || filesToProcess.length === 0) {
                statusText.textContent = 'Please upload one or more images first.';
                return;
            }

            resultsBody.innerHTML = '';
            extractedData = [];
            exportButton.classList.add('hidden');
            loader.classList.remove('hidden');
            processButton.disabled = true;
            uploadButton.disabled = true;

            try {
                const apiKey = "AIzaSyCzLdSYJFl7WsfZjPvOmhz11FDJJZxunWU"; // Provided by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const processingPromises = [];

                for (let i = 0; i < filesToProcess.length; i++) { // Iterate over the filesToProcess array
                    statusText.textContent = `Processing image ${i + 1} of ${filesToProcess.length}...`;
                    
                    const img = previewImages[i];
                    const file = filesToProcess[i]; // Get the original File object
                    
                    // Use the reliable file.type for MIME and extract base64 from the img.src
                    const mimeType = file.type; 
                    const base64ImageData = img.src.split(',')[1];

                    const prompt = `
                        From the provided image of a leaderboard, extract the names and their corresponding scores. 
                        Return the result as a JSON array of objects, where each object has a 'name' and a 'number' key. 
                        For example: [{ "name": "Player1", "number": 123 }]. 
                        Do not include any other text, explanations, or markdown formatting in your response. Just the raw JSON array.
                    `;

                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: mimeType, data: base64ImageData } }
                            ]
                        }],
                    };
                    
                    const promise = fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).then(response => {
                        // Improved error handling to give a specific status code
                        if (!response.ok) {
                            console.error(`API Error Status for image ${i+1}: ${response.status}`, response.statusText);
                            return response.text().then(text => {
                                throw new Error(`API call failed for image ${i+1} with status ${response.status}.`);
                            }).catch(() => {
                                // Fallback if response.text() also fails
                                throw new Error(`API call failed for image ${i+1} with status ${response.status}.`);
                            });
                        }
                        return response.json();
                    });

                    processingPromises.push(promise);
                }

                const results = await Promise.all(processingPromises);

                results.forEach(result => {
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const responseText = candidate.content.parts[0].text;
                        // Attempt to clean markdown wrapper (```json ... ```) that the model sometimes adds
                        const cleanedJsonString = responseText.replace(/```json\s*/g, '').replace(/\s*```/g, '').trim(); 
                        try {
                            const data = JSON.parse(cleanedJsonString);
                            extractedData = extractedData.concat(data);
                        } catch (e) {
                            console.error("Failed to parse JSON from AI response:", e, "Response Text:", cleanedJsonString);
                        }
                    }
                });

                displayResults();
                statusText.textContent = `Found a total of ${extractedData.length} records from ${filesToProcess.length} image(s).`;
                if (extractedData.length > 0) {
                    exportButton.classList.remove('hidden');
                } else {
                    resultsBody.innerHTML = '<tr><td colspan="2" class="px-6 py-10 text-center text-gray-500">AI could not extract data. Try clearer images.</td></tr>';
                }

            } catch (error) {
                console.error('AI Processing Error:', error);
                statusText.textContent = `An error occurred: ${error.message}`;
                resultsBody.innerHTML = `<tr><td colspan="2" class="px-6 py-10 text-center text-red-500">${error.message}</td></tr>`;
            } finally {
                loader.classList.add('hidden');
                processButton.disabled = false;
                uploadButton.disabled = false;
            }
        });

        function displayResults() {
            if (extractedData.length === 0) return;
            resultsBody.innerHTML = '';
            extractedData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.number}</td>
                `;
                resultsBody.appendChild(row);
            });
        }
        
        exportButton.addEventListener('click', () => {
            if (extractedData.length === 0) return;
            
            let csvRows = ["Name,Number"]; // Header row
            extractedData.forEach(row => {
                // Sanitize name for CSV (handles commas/quotes)
                const name = `"${String(row.name || '').replace(/"/g, '""')}"`;
                const number = row.number || '';
                csvRows.push(`${name},${number}`);
            });
            
            const csvString = csvRows.join("\n");
            // Use a Blob to ensure proper UTF-8 encoding with a BOM for Excel compatibility
            const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "leaderboard_data_combined.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>